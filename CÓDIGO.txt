import os
import datetime
import pandas as pd

def encontrar_ultimos_arquivos(caminho_pasta, codigos):
    arquivos_encontrados = []

    for raiz, dirs, arquivos in os.walk(caminho_pasta):
        for arquivo in arquivos:
            if arquivo.endswith('.txt') and any(codigo in arquivo for codigo in codigos):
                try:
                    data_arquivo = datetime.datetime.strptime(arquivo[-12:-4], '%Y%m%d')
                    caminho_completo = os.path.join(raiz, arquivo)
                    data_modificacao = datetime.datetime.fromtimestamp(os.path.getmtime(caminho_completo))

                    arquivos_encontrados.append((caminho_completo, data_arquivo, data_modificacao))
                except ValueError:
                    # Ignorar arquivos que não estejam no formato esperado
                    continue

    # Filtrar para manter apenas os mais recentes de cada código
    arquivos_finais = {}
    for arquivo, data_arquivo, data_modificacao in arquivos_encontrados:
        codigo = next(codigo for codigo in codigos if codigo in arquivo)
        if codigo not in arquivos_finais or (data_arquivo > arquivos_finais[codigo][1]) or (data_arquivo == arquivos_finais[codigo][1] and data_modificacao > arquivos_finais[codigo][2]):
            arquivos_finais[codigo] = (arquivo, data_arquivo, data_modificacao)

    return arquivos_finais

# Caminho para a pasta onde a busca será realizada
caminho_pasta = '/caminho/para/a/pasta'
codigos = ['codigo1', 'codigo2', 'codigo3']  # Lista de códigos para procurar

arquivos_finais = encontrar_ultimos_arquivos(caminho_pasta, codigos)

dados = {
    'Código': [],
    'Nome do Arquivo': [],
    'Data do Arquivo': [],
    'Última Modificação': []
}

for codigo, (arquivo, data_arquivo, ultima_modificacao) in arquivos_finais.items():
    dados['Código'].append(codigo)
    dados['Nome do Arquivo'].append(arquivo)
    dados['Data do Arquivo'].append(data_arquivo)
    dados['Última Modificação'].append(ultima_modificacao)

if dados['Código']:
    df = pd.DataFrame(dados)
    df.to_excel('resultados.xlsx', index=False)
    print(f"Arquivos encontrados: {len(dados['Código'])}")
else:
    print("Nenhum arquivo encontrado.")
