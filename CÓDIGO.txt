import win32com.client
import os

def listar_pastas():
    try:
        # Acessar o aplicativo do Outlook
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")

        # Listar todas as pastas principais
        for folder in outlook.Folders:
            print(f"Pasta: {folder.Name}")

            # Listar subpastas da pasta principal
            for subfolder in folder.Folders:
                print(f"  Subpasta: {subfolder.Name}")

    except Exception as e:
        print(f"Ocorreu um erro ao listar as pastas: {str(e)}")

def baixar_anexo_outlook(pasta_destino):
    try:
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")

        # Acessar a pasta "Caixa de Entrada" ou "Inbox"
        inbox = outlook.Folders.Item("Caixa de Entrada")  # Tente mudar para "Inbox" se não funcionar

        mensagens = inbox.Items
        filtro_assunto = "indicadores central de atendimento"
        
        mensagens = mensagens.Restrict(f"[Subject] = '{filtro_assunto}'")
        mensagens.Sort("[ReceivedTime]", True)

        if mensagens.Count == 0:
            print("Nenhum e-mail encontrado com o assunto especificado.")
            return

        email = mensagens.Item(1)
        print(f"Último e-mail encontrado:\nAssunto: {email.Subject}\nRecebido em: {email.ReceivedTime}")

        if email.Attachments.Count > 0:
            for anexo in email.Attachments:
                if anexo.FileName.endswith(".xls") or anexo.FileName.endswith(".xlsx"):
                    caminho_anexo = os.path.join(pasta_destino, anexo.FileName)
                    anexo.SaveAsFile(caminho_anexo)
                    print(f"Anexo {anexo.FileName} salvo em {caminho_anexo}")
                else:
                    print(f"Anexo {anexo.FileName} não é uma planilha.")
        else:
            print("Este e-mail não contém anexos.")

    except Exception as e:
        print(f"Ocorreu um erro: {str(e)}")

# Chame a função para listar as pastas antes de tentar baixar o anexo
listar_pastas()

# Definir o caminho onde a planilha será salva
pasta_destino = r'C:\caminho\para\salvar\anexo'

# Baixar o anexo do e-mail
baixar_anexo_outlook(pasta_destino)