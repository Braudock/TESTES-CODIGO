import win32com.client
import os
import pandas as pd

def listar_mensagens():
    # Acessar o aplicativo do Outlook
    outlook = win32com.client.Dispatch("Outlook.Application")
    namespace = outlook.GetNamespace("MAPI")
    
    # Acessar a pasta "Caixa de Entrada" (6 corresponde à Inbox)
    inbox = namespace.GetDefaultFolder(6)
    messages = inbox.Items

    # Ordenar as mensagens por data de recebimento (mais recentes primeiro)
    messages.Sort("[ReceivedTime]", True)

    # Exibir informações sobre as mensagens
    for message in messages:
        print("Assunto:", message.Subject)
        print("Data de Recebimento:", message.ReceivedTime)
        print("Remetente:", message.SenderName)
        print("Corpo:", message.Body)
        print("-" * 40)  # Linha separadora

    return messages

def baixar_anexo_outlook(mensagens, pasta_destino):
    # Filtrar e-mails com o assunto específico
    filtro_assunto = "indicadores central de atendimento"
    
    # Verificar se há mensagens
    if mensagens.Count == 0:
        print("Nenhum e-mail encontrado na caixa de entrada.")
        return

    # Encontrar o último e-mail com o assunto especificado
    for message in mensagens:
        if filtro_assunto.lower() in message.Subject.lower():
            print(f"Último e-mail encontrado:\nAssunto: {message.Subject}\nRecebido em: {message.ReceivedTime}")

            # Verificar se o e-mail contém anexos
            if message.Attachments.Count > 0:
                for anexo in message.Attachments:
                    if anexo.FileName.endswith(".xls") or anexo.FileName.endswith(".xlsx"):
                        # Verificar se o diretório de destino existe, se não, criar
                        if not os.path.exists(pasta_destino):
                            os.makedirs(pasta_destino)  # Cria o diretório se não existir

                        caminho_anexo = os.path.join(pasta_destino, anexo.FileName)
                        anexo.SaveAsFile(caminho_anexo)
                        print(f"Anexo {anexo.FileName} salvo em {caminho_anexo}")

                        # Filtrar dados da planilha
                        filtrar_planilha(caminho_anexo)
                    else:
                        print(f"Anexo {anexo.FileName} não é uma planilha.")
            else:
                print("Este e-mail não contém anexos.")
            return

    print("Nenhum e-mail encontrado com o assunto especificado.")

def filtrar_planilha(caminho_anexo):
    # Ler a planilha usando pandas
    try:
        df = pd.read_excel(caminho_anexo)

        # Filtrar apenas as linhas onde o cabeçalho 'Assunto' contém 'AGIR'
        df_filtrado = df[df['Assunto'].str.contains('AGIR', na=False)]

        # Definir o caminho para salvar a nova planilha
        novo_caminho = os.path.splitext(caminho_anexo)[0] + '_filtrado.xlsx'
        df_filtrado.to_excel(novo_caminho, index=False)

        print(f"Planilha filtrada salva em: {novo_caminho}")

    except Exception as e:
        print(f"Ocorreu um erro ao filtrar a planilha: {str(e)}")

# Definir o caminho onde a planilha será salva
pasta_destino = r'C:\caminho\para\salvar\anexo'  # Altere para o caminho desejado

# Listar mensagens na caixa de entrada
mensagens = listar_mensagens()

# Baixar o anexo do e-mail
baixar_anexo_outlook(mensagens, pasta_destino)